CREATE DATABASE GRAVICOR;

USE GRAVICOR



CREATE TABLE ACTIVO(
IDACTIVO INT NOT NULL PRIMARY KEY,
DESCRIPCION VARCHAR(15) NOT NULL
)

CREATE TABLE TIPOCAMION(
IDTIPOCAMION INT NOT NULL IDENTITY PRIMARY KEY,
DESCRIPCION VARCHAR(15) NOT NULL,
CAPACIDAD INT  NOT NULL,
TONELADAS  INT NOT NULL
)

CREATE TABLE CAMION(
IDCAMION INT NOT NULL IDENTITY PRIMARY KEY,
OPERADOR VARCHAR(50) NOT NULL,
IDTIPOCAMION INT NOT NULL REFERENCES TIPOCAMION(IDTIPOCAMION),
COLOR VARCHAR(15) NOT NULL,
ACTIVO INT REFERENCES ACTIVO(IDACTIVO)
)


CREATE TABLE IMPRESION(
IDIMPRESION INT NOT NULL IDENTITY PRIMARY KEY,
DIA DATE NOT NULL,
HORA TIME NOT NULL,
CAMIONID INT NOT NULL REFERENCES CAMION(IDCAMION)
)

CREATE TABLE USUARIO(
	IDUSUARIO INT NOT NULL IDENTITY PRIMARY KEY,
	EMAIL VARCHAR(50) NOT NULL,
	CONTRASENA VARCHAR(50) NOT NULL,
	NOMBRES VARCHAR(50) NOT NULL,
	APELLIDOS VARCHAR(50) NOT NULL,
	GESTIONPIEDRAGRENA BIT NOT NULL,
	GESTIONVENTAS BIT NOT NULL,
	REPORTES BIT NOT NULL,
	COBRANZA BIT NOT NULL,
	TESORERIA BIT NOT NULL,
	GESTIONGASTOSGENERALES BIT NOT NULL,
	CONFIGURACIONCUENTAS BIT NOT NULL,
	ACTIVO INT NOT NULL REFERENCES ACTIVO(IDACTIVO),
	USERNAME VARCHAR(50) NOT NULL
)

CREATE TABLE VIAJE(
IDVIAJE INT NOT NULL IDENTITY PRIMARY KEY,
IDUSUARIO INTEGER NOT NULL REFERENCES USUARIO(IDUSUARIO),
IDCAMION INTEGER NOT NULL REFERENCES CAMION(IDCAMION),
FECHA DATE NOT NULL,
HORA TIME NOT NULL,
ESACTIVO BIT NULL
)

CREATE TABLE TIPOPLANTA(
TIPOPLANTAID INT NOT NULL IDENTITY PRIMARY KEY,
DESCRIPCION VARCHAR(50) NOT NULL
)

CREATE TABLE PLANTA(
PLANTAID INTEGER NOT NULL IDENTITY PRIMARY KEY,
NOMBREPLANTA VARCHAR(50) NOT NULL,
TIPOPLANTAID INT NOT NULL REFERENCES TIPOPLANTA(TIPOPLANTAID),
COSTOOPERATIVO FLOAT NOT NULL
)



CREATE TABLE INVENTARIOPLANTA (
FECHAINVENTARIO DATE NOT NULL PRIMARY KEY,
PLANTAID INT NOT NULL REFERENCES PLANTA(PLANTAID),
INVENTARIOPIEDRAGRENA INT NOT NULL,
INVENTARIOPIEDRAPRODUCIDA INT NOT NULL
)

CREATE TABLE CLIENTE (
CLIENTEID INT NOT NULL IDENTITY PRIMARY KEY,
NOMBRECLIENTE VARCHAR(50) NOT NULL
)

CREATE TABLE MATERIAL(
MATERIALID INT NOT NULL IDENTITY PRIMARY KEY,
DESCRIPCIONMATERIAL VARCHAR(50) NOT NULL
)

CREATE TABLE PRECIO_CLIENTE_MATERIAL(
CLIENTEID INT NOT NULL REFERENCES CLIENTE(CLIENTEID),
MATERIALID INT NOT NULL REFERENCES MATERIAL(MATERIALID),
PRECIO FLOAT NOT NULL
)


CREATE TABLE FACTURA(
IDFACTURA VARCHAR(50) NOT NULL PRIMARY KEY,
MONTOFACTURA FLOAT NOT NULL,
FECHAFACTURA DATE NOT NULL,
ESPAGADO BIT NOT NULL,
FECHAPAGO DATE NULL,
PRECIOM3FACTURA FLOAT NOT NULL,
ESACTIVO INT NOT NULL REFERENCES ACTIVO(IDACTIVO)
)



CREATE TABLE VENTA(
VENTAID INT NOT NULL PRIMARY KEY,
CLIENTEID INT NOT NULL REFERENCES CLIENTE(CLIENTEID),
MATERIALID INT NOT NULL REFERENCES MATERIAL(MATERIALID),
FOLIOTRANSPORTISTA VARCHAR(50) NOT NULL,
MATRICULACAMION VARCHAR(50) NOT NULL,
NOMBRECHOFER VARCHAR(50) NOT NULL,
PLANTAID INTEGER NOT NULL REFERENCES PLANTA(PLANTAID),
FECHAVENTA DATE NOT NULL,
HORAVENTA TIME NOT NULL,
USUARIOID INT NOT NULL REFERENCES USUARIO(IDUSUARIO),
ACTIVO INT NOT NULL REFERENCES ACTIVO(IDACTIVO),
COSTOOPERATIVOPLANTAPRODUCTORA FLOAT NOT NULL,
ESFACTURADO BIT NOT NULL,
FACTURAID VARCHAR(50) NULL REFERENCES FACTURA(IDFACTURA),
PRECIOM3 FLOAT NOT NULL,
CANTIDADM3 INT NOT NULL
)



CREATE TABLE GASTOGENERAL(
GASTOGENERALID INT NOT NULL IDENTITY PRIMARY KEY,
IDFOLIOPAGO VARCHAR(50) NULL,
FECHAFOLIOPAGO DATE NULL,
FOLIOFACTURA VARCHAR(50) NOT NULL,
FECHAFACTURA DATE NOT NULL,
TOTAL FLOAT NOT NULL,
DESCRIPCION VARCHAR(50) NOT NULL,
EQUIPO VARCHAR(50) NOT NULL,
PROVEEDOR VARCHAR(50) NOT NULL,
ESACTIVO INT NOT NULL REFERENCES ACTIVO(IDACTIVO)
)

CREATE TABLE VENTAFANTASMA(
VANTAID INT NOT NULL IDENTITY PRIMARY KEY,
REFERENCIAVENTA INT NULL REFERENCES VENTA(VENTAID),
ESACTIVO INT NOT NULL REFERENCES ACTIVO(IDACTIVO),
IDFACTURA VARCHAR(50) NOT NULL REFERENCES FACTURA(IDFACTURA),
CANTIDADM3 INT NOT NULL,
ESCONCILIADA BIT NOT NULL
)

--PROCEDIMIENTO PARA AÑADIR UN NUEVO CLIENTE, CON LOS PRECIOS ASIGNADOS POR PRODUCTO, SIN QUE SE REPITA EL NOMBRE


USE GRAVICOR;
GO
CREATE PROCEDURE INSERTARCLIENTE
    @NOMBRECLIENTE nvarchar(50),   
    @PRECIO1 FLOAT,
	@PRECIO2 FLOAT,
	@PRECIO3 FLOAT 
AS   

IF EXISTS (SELECT CLIENTE.CLIENTEID  FROM CLIENTE WHERE CLIENTE.NOMBRECLIENTE = @NOMBRECLIENTE) 
	BEGIN
	   RETURN -1
	END
ELSE
	BEGIN
		BEGIN TRANSACTION
		DECLARE @ERROR INT;

		INSERT INTO CLIENTE VALUES (@NOMBRECLIENTE);
		DECLARE @IDCLIENTE INT;
		Select @IDCLIENTE = (select SCOPE_IDENTITY());
		INSERT INTO PRECIO_CLIENTE_MATERIAL VALUES (@IDCLIENTE,1,@PRECIO1);
		INSERT INTO PRECIO_CLIENTE_MATERIAL VALUES (@IDCLIENTE,2,@PRECIO2);
		INSERT INTO PRECIO_CLIENTE_MATERIAL VALUES (@IDCLIENTE,3,@PRECIO3);

		SET @ERROR = @@ERROR
		IF(@ERROR <> 0)
			BEGIN
				ROLLBACK
				RETURN 0
			END
		ELSE
			BEGIN
				COMMIT
				RETURN 1
			END
	END
GO
--ACABA PROCEDIMIENTO











